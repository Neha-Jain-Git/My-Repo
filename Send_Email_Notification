- name: Update LAST_GOOD_SHA_DDIQA environment variable
  env:
    GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
    OWNER: ${{ github.repository_owner }}
    REPO: ${{ github.event.repository.name }}
    ENV_NAME: DDIQA
    VARIABLE_NAME: LAST_GOOD_SHA_DDIQA
    SHA: ${{ github.sha }}
  run: |
    echo "Updating $VARIABLE_NAME in environment $ENV_NAME with SHA=$SHA"

    # Try to update (PATCH)
    RESPONSE=$(curl -s -o response.json -w "%{http_code}" \
      -X PATCH \
      -H "Accept: application/vnd.github+json" \
      -H "Authorization: Bearer $GITHUB_TOKEN" \
      https://api.github.com/repos/$OWNER/$REPO/environments/$ENV_NAME/variables/$VARIABLE_NAME \
      -d "{\"name\":\"$VARIABLE_NAME\",\"value\":\"$SHA\"}")

    if [ "$RESPONSE" -eq 404 ]; then
      echo "Variable not found, creating instead..."
      RESPONSE=$(curl -s -o response.json -w "%{http_code}" \
        -X POST \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer $GITHUB_TOKEN" \
        https://api.github.com/repos/$OWNER/$REPO/environments/$ENV_NAME/variables \
        -d "{\"name\":\"$VARIABLE_NAME\",\"value\":\"$SHA\"}")
    fi

    echo "HTTP Response: $RESPONSE"
    cat response.json