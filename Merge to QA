name: Merge to QA
on:
  workflow_dispatch:
permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: write
  repository-projects: write

env:
  PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

jobs:
  promote:
    runs-on: uhg-runner-m
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: QA
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config user.email "maltss_tech@optum.com"
          git config user.name "maltssdeploy"

      - name: Add remote and fetch source branch
        run: |
          git remote add source-origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git
          git fetch source-origin Dev

      - name: Get last promoted commit SHA
        id: lastqasha
        run: |
          if [ -z "${{ vars.LAST_PROMOTED_QA_SHA }}" ]; then
            echo "last_sha=origin/QA" >> $GITHUB_OUTPUT
          else
            echo "last_sha=${{ vars.LAST_PROMOTED_QA_SHA }}" >> $GITHUB_OUTPUT
          fi

      - name: Find delta changes (adds/modifies)
        id: delta
        run: |
          git checkout source-origin/Dev
          echo "changed_files=$(git diff --name-only ${{ steps.lastqasha.outputs.last_sha }}..HEAD --diff-filter=ACMRT -- force-app/main/default/)" >> $GITHUB_OUTPUT

      - name: Find deleted files
        id: deleted
        run: |
          git checkout source-origin/Dev
          echo "deleted_files=$(git diff --name-only ${{ steps.lastqasha.outputs.last_sha }}..HEAD --diff-filter=D -- force-app/main/default/)" >> $GITHUB_OUTPUT

      - name: Checkout target branch again
        run: git checkout QA

      - name: Apply delta changes
        run: |
          for file in ${{ steps.delta.outputs.changed_files }}; do
            git checkout source-origin/Dev -- "$file"
          done
          git add force-app/main/default/

          for file in ${{ steps.deleted.outputs.deleted_files }}; do
            git rm -f "$file"
          done

          git commit -m "Delta merge force-app/main/default from Dev (with deletions)" || echo "No changes to commit"

      - name: Push changes
        run: git push origin HEAD:QA

      - name: Update LAST_PROMOTED_QA_SHA in GitHub Environment
        run: |
          NEW_SHA=$(git rev-parse source-origin/Dev)
          echo "Updating LAST_PROMOTED_QA_SHA to $NEW_SHA"
          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/environments/production/variables/LAST_PROMOTED_QA_SHA \
            -d "{\"name\":\"LAST_PROMOTED_QA_SHA\",\"value\":\"$NEW_SHA\"}"
